---
title: 'Estudi GLBALDIAB 2007-2018. Fecha de corte:  `r params$bd.dindex1`'
author: "Jordi Real & Rai Puig"
website: "https://github.com/USR-DAPCAT/"

date: "`r format(Sys.time(), '%d %B, %Y')`"


output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    fig_caption: true
    css: logos_css/usr_styles.css
  pdf_document: default
  word_document: default

params:
  dir_dades_origen: "../DADES/GLOBALDIAB2/mostra" # "../../DADES/GLOBALDIAL2/mostra"
  dir_dades_desti: "dades/mostra" 
  bd.dindex1: '20180101'
  bd.dindex2: '20181231'
---


&nbsp;
<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"https://www.idiapjgol.org/images/logo.png\" style=\"float: right ;width: 130px;\"/>')
     $head.prepend('<img src=\"https://avatars2.githubusercontent.com/u/57066591?s=200&v=4\" style=\"margin-left:25% ;width: 80px;\"/>')
     $head.prepend('<img src=\"logoDAP_Cat.png\" style=\"float: left:1;width: 185px;\"/>')
   });
</script>



<div class="watermark">DRAFT</div>




# FASE LECTURA

>> Generacion de tabla plana y aplicacion de los primeros criterios inclusion 

```{r setup, include = FALSE}
#rm(list=ls())
library(dplyr)

# Funcions (provisional, quan tinguem la llibreria , ja no caldra!!!) 
#link_source<-paste0("https://github.com/jrealgatius/Stat_codis/blob/master/funcions_propies.R","?raw=T")
#devtools::source_url(link_source)

conductor_codis<-here::here("CATALEG.xlsx")

directori_dades_origen<-params$dir_dades_origen

dt_cataleg<-readxl::read_excel(conductor_codis,col_types = "text")%>% select(cod,domini,agr)


#
#
#[S'ha d'instal.lar les llibreries:
#i)       Platan(aplanar les bases de dades.DapCat)
#ii)      Formatge(formatejar dades.DapCat)
#iii)     Macedonia(altres funcions.DapCat )
#
# library("devtools")
library("dplyr")
library("kableExtra")
library("Platan")
library("FormatGe")

#devtools::install_github("USR-DAPCAT/Platan",build_vignettes = TRUE)
#devtools::install_github("USR-DAPCAT/FormatGe",build_vignettes = TRUE)
#devtools::install_github("USR-DAPCAT/Macedonia",build_vignettes = TRUE)
#devtools::install_github("USR-DAPCAT/ggflowchart2",build_vignettes = TRUE)
#library("Platan")
#library("FormatGe")
#library("Macedonia")
#library("ggflowchart2")
```


## 1. Lectura previa DataIndex 
```{r lectura1, include=T}

# 1 Lectura -----------

#i)

#[uni]
dt_poblacio<-readRDS(here::here(directori_dades_origen,"GLOBALDIAB2_entregable_poblacio_20221118.rds")) %>% as_tibble()
#variable.names(dt_poblacio)
#[1] "idp"      "sexe"     "situacio" "dnaix"    "entrada"  "sortida"  "agr_pais"
dt_poblacio_ESP<-readRDS(here::here(directori_dades_origen,"GLOBALDIAB2_entregable_poblacio_esp_20221118.rds")) %>% as_tibble()


#ii)
dt_diagnostics<-readRDS(here::here(directori_dades_origen,"GLOBALDIAB2_entregable_diagnostics_20221118.rds"))%>%
  as_tibble()


#iii)
dt_analitiques<-readRDS(here::here(directori_dades_origen,"GLOBALDIAB2_entregable_variables_analitiques_20221118.rds"))%>%
  as_tibble()

dt_cliniques<-readRDS(here::here(directori_dades_origen,"GLOBALDIAB2_entregable_variables_cliniques_20221118.rds"))%>%
  as_tibble()
# Fusiono cliniques + variables

dt_variables<-dt_analitiques%>%
   bind_rows(dt_cliniques)%>%
    select(-agr)%>%
     left_join(select(dt_cataleg,cod,agr),by="cod")%>% 
       select(-cod)%>%
        rename(cod=agr)



#iv)
dt_facturacions<-readRDS(here::here(directori_dades_origen,"GLOBALDIAB2_entregable_farmacs_facturats_20221118.rds"))%>%
  as_tibble()
#v)
dt_prescripcions<-readRDS(here::here(directori_dades_origen,"GLOBALDIAB2_entregable_farmacs_prescrits_20221118.rds"))%>%
   as_tibble()

```


```{r calcul_deNs, include=T, warning=FALSE}

# Actualitzo data sortida en funci贸 de trasllat (situacio=="T")
# Obviem Trasllats

dt_temp<-dt_poblacio

# dt_temp2<-dt_temp %>% mutate(sortida=ifelse(situacio=="T", sortida, 20201231))
# dt_temp2<-dt_temp %>% mutate(sortida=ifelse(situacio=="D", sortida, 20220630))
# dt_temp2<-dt_temp %>% mutate(sortida=ifelse(situacio=="T", 20220630,sortida))

N_actiu_01Gener<-function(dt=dt_temp,any="2010") {
  # dt=dt_temp
  # any="2010"
  dt %>% summarise(N=sum(sortida>=paste0(any,"0101") & entrada<=paste0(any,"0101")))}

TaulaNs<-
  c(2000:2019) %>% purrr::set_names(c(2000:2019)) %>% 
  purrr::map_df(~ 
               N_actiu_01Gener(dt=dt_temp, any=.x),.id="Year")

TaulaNs %>% kable() %>% kableExtra::kable_classic_2()


#write.csv2(taulaNs,"taulaNs.csv")

```



## 2. Generar DataIndex DM2-Debut
```{r generacio_dtindex_SCRIP, include=F, eval=TRUE}



# 1. Data index DM2 segons codi diagnostic #
dt_codis<-readxl::read_excel(conductor_codis,col_types = "text") %>% select(domini,cod,agr) %>% filter(agr=="DM2")

dt_index1<-dt_diagnostics %>% semi_join(dt_codis,by="cod") %>% group_by(idp) %>% slice(which.min(dat)) %>% ungroup() %>% transmute(idp,dtindex=as.character(dat))


# 2. Data index DM2 segons HbA1c >=6.5 # 
# Busco la data minima  d'una GLICADA >=6.5, de cada pacient.
dt_index2<-dt_variables %>% filter(cod=="GLICADA") %>% filter(val>=6.5) %>% group_by(idp) %>% slice(which.min(dat)) %>% ungroup() %>% transmute(idp,dtindex_HB=as.character(dat))

# 3. Data index DM2 segons Farmacs antidiabetics prescrits
dt_codis<-readxl::read_excel(conductor_codis,col_types = "text") %>% select(domini,cod,agr) %>% 
  filter(domini=="farmacs" & agr=="ANTIDIAB") %>% distinct(cod) %>% mutate(agr="ANTIDIAB")
  
dt_temp_primeradata<-
  dt_prescripcions %>% semi_join(dt_codis,by="cod") %>% 
  agregar_prescripcions(bd.dindex = "22000101", dt.agregadors = dt_codis,finestra.dies = c(-Inf, + Inf),agregar_data = T) %>% 
  select(idp,dtindex=FP.ANTIDIAB)

dt_ANTIDIAB_CUMUL<-
  dt_prescripcions %>% semi_join(dt_codis,by="cod") %>% 
  agregar_prescripcions(bd.dindex = "22000101", dt.agregadors = dt_codis,finestra.dies = c(-Inf, + Inf),agregar_data = F) %>% 
  filter(FP.ANTIDIAB>90) %>% select(-dtindex)

dt_index3a <-dt_ANTIDIAB_CUMUL %>% left_join(dt_temp_primeradata,by="idp")  %>% mutate(dtindex=data.to.string(dtindex))

# 4. Data index DM2 segons Farmacs antidiabetics dispensats/facturats
dt_index3b<-
  dt_facturacions %>% semi_join(dt_codis,by="cod") %>% select(idp,cod,dat,env) %>% distinct() %>% 
  group_by(idp) %>% summarise(sum_env=sum(env), data_1a=min(dat)) %>% ungroup() %>% 
  filter(sum_env>=3) %>% 
  select(idp,dtindex=data_1a) %>% mutate(dtindex=paste0(dtindex,"15"))

dt_index3<-dt_index3a %>% bind_rows(dt_index3b) %>% group_by(idp) %>% slice(which.min(dtindex)) %>% ungroup() %>% select(idp,dtindex_FX=dtindex)


# 6. Data index DM2 segons complicacions de la diabetis (RD , Retino, Neuro diabetica etc.. )
dt_codis<-readxl::read_excel(conductor_codis,col_types = "text") %>% select(domini,cod,agr,Comp_DM) %>% filter(!is.na(Comp_DM)) %>% 
  distinct(cod)

dt_index4<-dt_diagnostics %>% 
  semi_join(dt_codis,by="cod") %>% group_by(idp) %>% slice(which.min(dat)) %>% ungroup() %>% select(idp,dtindex=dat) %>% 
  transmute(idp,dtindex_comp=as.character(dtindex))


######### Combinaci贸 de criteris per DM2

#dt_index1 (DM2)

### Dos criteris entre els 2 seguents
dt_temp<-dt_index2 %>% 
  full_join(dt_index3,by = "idp") %>% full_join(dt_index4,by = "idp") %>%
  mutate(COUNT_HB2=dtindex_HB,COUNT_FX=dtindex_FX,COUNT_comp=dtindex_comp)

dt_temp<-mutate_at(dt_temp, vars( starts_with("COUNT_") ), funs( if_else(.==0  | is.na(.)  ,0,1)))

dt_temp<-dt_temp%>%mutate(COUNT=COUNT_HB2+COUNT_FX+COUNT_comp)%>%filter(COUNT>=2) %>% 
  mutate(data_min=pmin(dtindex_HB,dtindex_FX,na.rm = T)) %>% 
  select(idp,dtindex =data_min)

# Fusi贸 de dos criteris
dt_index_global<-dt_index1 %>% bind_rows(dt_temp) %>% group_by(idp) %>% slice(which.min(dtindex))
dt_index<-dt_index_global



#fet per mi!!!

#filtrem per l any que volem estiduidiar 

dt_temp<-dt_index%>%
  left_join(dt_poblacio,by="idp") %>% 
    mutate(sortida=ifelse(situacio=="T", sortida, 20201231))%>%
     filter(sortida>=params$bd.dindex2 & entrada<=params$bd.dindex1)
  
# filtrar per any!!, i o reonvertim dt_index.

dt_temp<-dt_temp %>%select(idp,dtindex)
dt_index<-dt_temp

#dt_temp



```


```{r algoritmeDM2, eval=FALSE}


### Algoritme que identifica DM2 en funci贸 de diagnostics, farmacsAD i Glicada>=6.5

## Entren Problemes de salut + cataleg de Llistat de codis CIM DM2, 
## 2 fitxers farmacs prescrits/facturats  + cataleg de llistat de codis ATC
## 1 fitxer historic de glicades (Glicada)

# Sortida --> identificador, data

Generar_DM2<-function(dt_diagnostics, dt_glicades,dt_facturacio,dt_prescripcions, dt_cataleg) {
  
  
  
  }



```




## 4. Agregacion de nuestros ficheros a partir del catalago
```{r agregacio, include=T, eval=TRUE}


codis_altresDM<-dt_cataleg %>% filter(domini=="diagnostics") %>% 
  filter(agr=="DM1" | agr=="DMG") 


#Agregacio Problemes de Salut.
dtagr_diagnostics<-agregar_problemes(dplyr::select(dt_diagnostics,idp,cod,dat),
                                     bd.dindex = dt_index,
                                     dt.agregadors=codis_altresDM,
                                     finestra.dies=c(-Inf,0),prefix = "DG.",
                                     cataleg_mana=FALSE)


dtagr_diagnostics<-dtagr_diagnostics%>%select(-dtindex)

```


## 5. Fusion 1

Fusionar part dels arxius agregats 
 
```{r fusio1}



dt_plana<-dt_poblacio_ESP %>% 
  left_join(dt_index, by="idp") %>%
  left_join(dtagr_diagnostics,by="idp")
       


```


## 5. Salvar  
```{r SALVAR}

saveRDS(dt_plana, file=here::here(params$dir_dades_desti,"dt_plana.rds"))


```



