---
title: 'Estudi GLBALDIAB 2007-2018. Fecha de corte:  `r params$bd.dindex1`'
author: "Jordi Real & Rai Puig"
website: "https://github.com/USR-DAPCAT/"

date: "`r format(Sys.time(), '%d %B, %Y')`"


output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    fig_caption: true
    css: logos_css/usr_styles.css
  pdf_document: default
  word_document: default

params:
  dir_dades_origen: "../../DADES/GLOBALDIAB2/mostra" # "../../DADES/GLOBALDIAL2/mostra"
  dir_dades_desti: "dades" 
  bd.dindex1: '20190101'
  bd.dindex2: '20190101'
---


&nbsp;
<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"https://www.idiapjgol.org/images/logo.png\" style=\"float: right ;width: 130px;\"/>')
     $head.prepend('<img src=\"https://avatars2.githubusercontent.com/u/57066591?s=200&v=4\" style=\"margin-left:25% ;width: 80px;\"/>')
     $head.prepend('<img src=\"logoDAP_Cat.png\" style=\"float: left:1;width: 185px;\"/>')
   });
</script>



<div class="watermark">DRAFT</div>




# FASE LECTURA

>> Generacion de tabla plana y aplicacion de los primeros criterios inclusion 

```{r setup, include = FALSE}
#rm(list=ls())
library(dplyr)

# Funcions (provisional, quan tinguem la llibreria , ja no caldra!!!) 
#link_source<-paste0("https://github.com/jrealgatius/Stat_codis/blob/master/funcions_propies.R","?raw=T")
#devtools::source_url(link_source)

conductor_codis<-here::here("CATALEG.xlsx")

directori_dades_origen<-params$dir_dades_origen

dt_cataleg<-readxl::read_excel(conductor_codis,col_types = "text")%>% select(cod,domini,agr)


#
#
#[S'ha d'instal.lar les llibreries:
#i)       Platan(aplanar les bases de dades.DapCat)
#ii)      Formatge(formatejar dades.DapCat)
#iii)     Macedonia(altres funcions.DapCat )
#
library("devtools")
library("dplyr")
library("kableExtra")
library("Platan")
library("FormatGe")

#devtools::install_github("USR-DAPCAT/Platan",build_vignettes = TRUE)
#devtools::install_github("USR-DAPCAT/FormatGe",build_vignettes = TRUE)
#devtools::install_github("USR-DAPCAT/Macedonia",build_vignettes = TRUE)
#devtools::install_github("USR-DAPCAT/ggflowchart2",build_vignettes = TRUE)
#library("Platan")
#library("FormatGe")
#library("Macedonia")
#library("ggflowchart2")
```

```{r estructura_carpetes, eval=FALSE}
# estructura de carpetes: /dades /codi /outputs /docs
#
# Genero el directori si no existeic
#directori<-paste0("dades")
#if (!file.exists(directori)) {dir.create(file.path(directori), showWarnings = FALSE)}
#  
#directori<-paste0("codi")
#if (!file.exists(directori)) {dir.create(file.path(directori), showWarnings = FALSE)}
#
#directori<-paste0("outputs")
#if (!file.exists(directori)) {dir.create(file.path(directori), showWarnings = FALSE)}
#
#directori<-paste0("docs")
#if (!file.exists(directori)) {dir.create(file.path(directori), showWarnings = FALSE)}
#
#######################################################################################

```
## 1. Lectura previa DataIndex 
```{r lectura1, include=T}

# 1 Lectura -----------

#i)

#[uni]
dt_poblacio<-readRDS(here::here(directori_dades_origen,"GLOBALDIAB2_entregable_poblacio_20221118.rds")) %>% as_tibble()
#variable.names(dt_poblacio)
#[1] "idp"      "sexe"     "situacio" "dnaix"    "entrada"  "sortida"  "agr_pais"
dt_poblacio_ESP<-readRDS(here::here(directori_dades_origen,"GLOBALDIAB2_entregable_poblacio_esp_20221118.rds")) %>% as_tibble()


#ii)
dt_diagnostics<-readRDS(here::here(directori_dades_origen,"GLOBALDIAB2_entregable_diagnostics_20221118.rds"))%>%
  as_tibble()


#iii)
dt_analitiques<-readRDS(here::here(directori_dades_origen,"GLOBALDIAB2_entregable_variables_analitiques_20221118.rds"))%>%
  as_tibble()

dt_cliniques<-readRDS(here::here(directori_dades_origen,"GLOBALDIAB2_entregable_variables_cliniques_20221118.rds"))%>%
  as_tibble()
# Fusiono cliniques + variables

dt_variables<-dt_analitiques%>%
   bind_rows(dt_cliniques)%>%
    select(-agr)%>%
     left_join(select(dt_cataleg,cod,agr),by="cod")%>% 
       select(-cod)%>%
        rename(cod=agr)



#iv)
dt_facturacions<-readRDS(here::here(directori_dades_origen,"GLOBALDIAB2_entregable_farmacs_facturats_20221118.rds"))%>%
  as_tibble()
#v)
dt_prescripcions<-readRDS(here::here(directori_dades_origen,"GLOBALDIAB2_entregable_farmacs_prescrits_20221118.rds"))%>%
   as_tibble()

```


```{r calcul_deNs, include=T, warning=FALSE}

# Actualitzo data sortida en funció de trasllat (situacio=="T")
# Obviem Trasllats

dt_temp<-dt_poblacio

dt_temp2<-dt_temp %>% mutate(sortida=ifelse(situacio=="T", sortida, 20201231))


taulaNs<-dt_temp2 %>% summarise(N2000=sum(sortida>=20000101 & entrada<=20000101),
                                N2001=sum(sortida>=20010101 & entrada<=20010101),
                                N2002=sum(sortida>=20020101 & entrada<=20020101),
                                N2003=sum(sortida>=20030101 & entrada<=20030101),
                                N2004=sum(sortida>=20040101 & entrada<=20040101),
                                N2005=sum(sortida>=20050101 & entrada<=20050101),
                                N2006=sum(sortida>=20060101 & entrada<=20060101),
                                N2007=sum(sortida>=20070101 & entrada<=20070101),
                                N2008=sum(sortida>=20080101 & entrada<=20080101),
                                N2009=sum(sortida>=20090101 & entrada<=20090101),
                                N2010=sum(sortida>=20100101 & entrada<=20100101),
                                N2011=sum(sortida>=20110101 & entrada<=20110101),
                                N2012=sum(sortida>=20120101 & entrada<=20120101),
                                N2013=sum(sortida>=20130101 & entrada<=20130101),
                                N2014=sum(sortida>=20140101 & entrada<=20140101),
                                N2015=sum(sortida>=20150101 & entrada<=20150101),
                                N2016=sum(sortida>=20160101 & entrada<=20160101),
                                N2017=sum(sortida>=20170101 & entrada<=20170101),
                                N2018=sum(sortida>=20180101 & entrada<=20180101),
                                N2019=sum(sortida>=20190101 & entrada<=20190101))

taulaNs %>% kable() %>% kableExtra::kable_classic_2()

#write.csv2(taulaNs,"taulaNs.csv")

```


##2. Generar DataIndex Disseny Transversal
```{r generem la data_Index1, include=F}

# 2 Data.Index -----------

#[29.4.2021]#:

#[29.4.2021]#: (2016-2018)
dt_index0<-
  dt_poblacio %>% select(idp,entrada,sortida) %>% mutate(kk=1) %>%
  left_join(tibble(dtindex=seq(params$bd.dindex1,params$bd.dindex2,by=10000),kk=1),by="kk") %>%
  filter(entrada<=dtindex & dtindex<=sortida)  %>%  # Filtro per usuari actiu en data index
  select(-c(kk,entrada,sortida))

gc()


```
## 2. Generacio DataIndex DM2-Debut
```{r generacio_dtindex2, include=F}


##Nota SIDIAP:
# - Condició c) no disponible

# - Codis Diagnostics segons cataleg proporcionat (Només E-CAP)
# - CMBDH no disponible 


# - Condició b) Prescripció de com a mínim 3 mesos glucose-lowering medication una vegada definit l’agregador
#1.	Temps acumulat de prescripció > 3mesos  
#2.	3 envasos de facturació 
#
#Condició a) HbA1c
#2 o més HbA1c >=6.5 dins d’un periode de 6 mesos: 
#-	2 o més >=6.5 
#-	Temps entre la primera I la última <=6 mesos  (Data 1a I data ultima)






# - Codis Diagnostics segons cataleg proporcionat (Només E-CAP)
# - CMBDH no disponible 


# Codis de inclusió 
dt_cataleg2<-readxl::read_excel(conductor_codis,col_types = "text") %>% 
  select(domini,cod,agr) %>% 
  filter(agr=="DM2")


#i) Busco la data minima del primer diagnostic de Dm2, de cada pacient.
dt_index1<-agregar_problemes(select(dt_diagnostics,idp,cod,dat),
                                           bd.dindex = 20221212,
                                           dt.agregadors=select(dt_cataleg2,cod,agr=agr),
                                           finestra.dies=c(-Inf,+Inf),prefix = "Diag_",cataleg_mana=T) %>% 
                                                select(idp,dtindex=Diag_DM2) 

#dt_index1%>%filter(idp=="00d79410ce05217612c77d1b38b85970a7622a56")







# - Condició b) Prescripció de com a mínim 3 mesos glucose-lowering medication una vegada definit l’agregador
#1.	Temps acumulat de prescripció > 3mesos  
#2.	3 envasos de facturació 

# Codis de inclusió 
dt_cataleg2<-readxl::read_excel(conductor_codis,col_types = "text") %>% 
  select(domini,cod,agr) %>% 
  filter(agr=="ANTIDIAB")

#ii) Busco la data minima del primer diagnostic de Farmac facturat de Dm2, de cada pacient.


dt_facturacions2<-dt_facturacions%>%mutate(dbaixa=20223112,dat=(paste0(as.character(dat), "15")))



dt_index2a<-agregar_problemes(dt=dt_facturacions2,
                                           bd.dindex=20220101,
                                           finestra.dies=c(-Inf,+Inf),
                                           dt.agregadors=dt_cataleg2,
                                           prefix="FF.",
                                           camp_agregador="agr",
                                           cataleg_mana =FALSE)%>%
                                             transmute(idp,dtindex=FF.ANTIDIAB)

dt_index2a<-dt_index2a%>%mutate(dtindex=as.integer(dtindex))


temp_facturacions<-dt_facturacions%>% 
    semi_join(dt_index2a,by="idp")  


temp_facturacions2<- 
  temp_facturacions %>% agregar_facturacio(finestra.dies = c(-Inf,+Inf),
                                     dt.agregadors=select(dt_cataleg2,cod,agr=agr),
                                     prefix = "FF.",
                                     camp_agregador="agr",
                                     agregar_data=FALSE)%>%filter(FF.ANTIDIAB>3)




dt_index2a<-dt_index2a%>% 
    semi_join(temp_facturacions2,by="idp")  



#dt_index2a%>%filter(idp=="00d79410ce05217612c77d1b38b85970a7622a56")
#mirarem , aquells que tenen la data minim, si compleixen que tenen com a minim 3 envasos!










dt_index2b<-agregar_problemes(dt=dt_prescripcions,
                                           bd.dindex=20220101,
                                           finestra.dies=c(-Inf,+Inf),
                                           dt.agregadors=dt_cataleg2,
                                           prefix="FP.",
                                           camp_agregador="agr",
                                           cataleg_mana =FALSE
                                           ) %>% transmute(idp,dtindex=FP.ANTIDIAB) 
                      
  

temp_prescripcions<-dt_prescripcions%>% 
    semi_join(dt_index2b,by="idp")  

#Agregacio Farmacs Prescripcions.: temps acumulat de prescripció > 3mesos  
temp_prescripcions2<-agregar_prescripcions(dt=temp_prescripcions,
                                           bd.dindex=20220101,
                                           finestra.dies=c(-Inf,+Inf),
                                           dt.agregadors=dt_cataleg2,
                                           prefix="FP.",
                                           camp_agregador="agr",
                                           agregar_data=FALSE,
                                           cataleg_mana =FALSE,
                                           acumular=NULL)%>%filter(FP.ANTIDIAB>90)

dt_index2b<-dt_index2b%>% 
    semi_join(temp_prescripcions2,by="idp")  





#dt_index2b%>%filter(idp=="00d79410ce05217612c77d1b38b85970a7622a56")





#Condició a) HbA1c
#2 o més HbA1c >=6.5 dins d’un periode de 6 mesos: 
#-	2 o més >=6.5 
#-	Temps entre la primera I la última <=6 mesos  (Data 1a I data ultima)

    
mtcars %>%
  group_by(cyl) %>%
  summarise(disp = mean(disp), sd = sd(disp))    
    
#iii) Busco la data minima  d'una GLICADA >=6.5, de cada pacient.
dt_index3<- 
  dt_variables %>% filter(cod=="GLICADA") %>% 
  filter(val>=6.5) %>% group_by(idp) %>% slice(which.min(dat)) %>% ungroup() %>% 
  select(idp,dtindex=dat)



dt_index3<- 
  dt_variables %>% filter(cod=="GLICADA") %>% 
  filter(val>=6.5) %>% group_by(idp) %>% summarise(dtindex = min(dat),dat_min = min(dat),dat_max = max(dat),rest=lubridate::ymd(dat_max)-lubridate::ymd(dat_min))   %>% ungroup()

dt_index3$rest<-as.numeric(dt_index3$rest)

dt_index3<-dt_index3%>% filter(rest<=183 & rest>0 )%>%
  select(idp,dtindex)



#dt_index3%>%filter(idp=="00d79410ce05217612c77d1b38b85970a7622a56")

#dt_index1
#dt_index2
#dt_index3

#iv) Un cop tinc les tres Dates minimes,escolleixo la MÍNIMA.

# Fusió de tot 
dt_index<-
  dt_index1 %>% bind_rows(dt_index2a) %>% bind_rows(dt_index2b) %>% bind_rows(dt_index3) %>% 
  group_by(idp) %>%  slice(which.min(dtindex)) %>% ungroup() 



dt_temp<-dt_index%>%
  left_join(dt_poblacio,by="idp") %>% 
    mutate(sortida=ifelse(situacio=="T", sortida, 20201231))%>%
     filter(sortida>=params$bd.dindex1 & entrada<=params$bd.dindex1)
  
# filtrar per any!!, i o reonvertim dt_index.

dt_temp<-dt_temp %>%select(idp,dtindex)
dt_index<-dt_temp

#dt_temp

```

```{r prova, eval=FALSE}




#########
# PROVA #
#########

dt=dt_prescripcions
bd.dindex=20220101
finestra.dies=c(-Inf,+Inf)
dt.agregadors=dt_cataleg2
prefix="FP."
camp_agregador="agr"
agregar_data=TRUE
cataleg_mana =FALSE
acumular=acumular


finestra.dies = ifelse(finestra.dies == +Inf, 99999, finestra.dies)
finestra.dies = ifelse(finestra.dies == -Inf, -99999, finestra.dies)

dt <- afegir_dataindex(dt, bd.dindex)
dt <- dt %>% dplyr::mutate(dat = lubridate::ymd(dat), dbaixa = ifelse(is.na(dbaixa), 
        30160101, dbaixa), dbaixa = lubridate::ymd(dbaixa), dtindex = lubridate::ymd(dtindex))
dt.agregadors <- dt.agregadors %>% dplyr::select_("cod",agr = camp_agregador)
dt.agregadors <- dt.agregadors %>% dplyr::filter(!is.na(agr))

prescripcions_agr <- dt %>% dplyr::select(idp, dtindex, cod, 
        dat, dbaixa, acumular) %>% dplyr::mutate(overlap = pmax(pmin(dtindex + 
        lubridate::days(finestra.dies[2]), dbaixa) - pmax(dtindex + 
        lubridate::days(finestra.dies[1]), dat) + 1, 0), overlap = as.numeric(overlap)) %>% 
        dplyr::filter(overlap > 0)
    
    
    
    if (is.null(acumular)) {
        prescripcions_agr <- prescripcions_agr %>% dplyr::inner_join(dplyr::select(dt.agregadors, 
            c(cod, agr)), by = "cod") %>% dplyr::distinct(idp, 
            dtindex, cod, agr, .keep_all = TRUE)
    }
    if (!is.null(acumular)) {
        acumular <- rlang::sym(acumular)
        prescripcions_agr <- prescripcions_agr %>% dplyr::inner_join(dplyr::select(dt.agregadors, 
            c(cod, agr)), by = "cod") %>% dplyr::distinct(idp, 
            dtindex, cod, agr, !!acumular, .keep_all = TRUE)
    }
    if (!(agregar_data) & is.null(acumular)) {
        prescripcions_agr <- prescripcions_agr %>% dplyr::group_by(idp, 
            dtindex, agr) %>% dplyr::summarise(FX = sum(overlap, 
            na.rm = T)) %>% dplyr::ungroup()
    }
    if (!is.null(acumular)) {
        prescripcions_agr <- prescripcions_agr %>% dplyr::group_by(idp, 
            dtindex, agr) %>% dplyr::summarise(FX = sum(overlap * 
            !!acumular, na.rm = T)) %>% dplyr::ungroup()
    }
    if (agregar_data) {
        prescripcions_agr <- prescripcions_agr %>% dplyr::mutate(int1 = dtindex + 
            lubridate::days(finestra.dies[1]), data0 = ifelse(dat >= 
            int1, dat, int1), data0 = lubridate::as_date(data0)) %>% 
            tibble::as_tibble() %>% dplyr::select(idp, dtindex, 
            agr, dat = data0) %>% dplyr::group_by(idp, dtindex, 
            agr) %>% dplyr::slice(which.min(dat)) %>% dplyr::ungroup() %>% 
            dplyr::rename(FX = dat)
    }
    if (cataleg_mana) {
        pp <- dplyr::select(dt.agregadors, agr) %>% dplyr::distinct() %>% 
            dplyr::anti_join(prescripcions_agr %>% dplyr::distinct(agr), 
                by = "agr")
        porca <- prescripcions_agr %>% dplyr::distinct(idp, dtindex) %>% 
            merge(pp) %>% tibble::as_tibble()
        prescripcions_agr <- prescripcions_agr %>% dplyr::bind_rows(porca)
    }
    prescripcions_agr <- prescripcions_agr %>% tidyr::spread(agr, 
        FX, sep = ".")
    names(prescripcions_agr) <- sub("agr.", prefix, names(prescripcions_agr))
    prescripcions_agr





## 3. Lectura posterior a DataIndex 
```{r lectura2, include=T}

# 3 Lectura posterior a DataIndex -----------

#17.02.2021#
#dt_cataleg<-readxl::read_excel(conductor_codis,col_types = "text")%>%select(cod,DM2,agr0,agr,agr1,agr_Farmac,agr11,agr1_amp,agr_Niad,agr_Insul_Ado,agr_Comp_Vasc,agr_CVD,agr_Comp_Vasc2)




#vi)
dt_tabaquisme<-readRDS(here::here(directori_dades_origen,"GLOBALDIAB2_entregable_tabaquisme_20221118.rds"))%>% 
  as_tibble()%>% 
    semi_join(dt_index,by="idp")








```
## 4. Agregacio dels nostres fitxers a partir del cataleg
```{r agregacio, include=T}

# 4 Agregacio dels nostres fitxers a partir del cataleg -----------


#Falta apartat  a) ,b) i c)

#1.	La diabetes se determinará y definirá sobre la base de un diagnóstico o código de diagnóstico proporcionado por un profesional sanitario pertinente, o al menos dos de:

#a).	la presencia de dos o más valores de glucosa en sangre o HbA1c dentro de los rangos de diagnóstico para diabetes (glucosa en plasma en ayunas ≥7,0 mmol/l (126 mg/dl), glucosa en plasma al azar o a las 2 horas ≥11,1 mmol/l (200 mg/dl) ) o HbA1c ≥6,5 % (48 mmol/mol)), en un período de 6 meses;

#b).	prescripción de medicamentos para bajar la glucosa durante al menos 3 meses;

#c).	la prestación de un servicio exclusivo para las personas con diabetes.




#Agregacio Problemes de Salut.
dtagr_diagnostics<-agregar_problemes(dplyr::select(dt_diagnostics,idp,cod,dat),
                                     bd.dindex = dt_index,
                                     dt.agregadors=dt_cataleg,
                                     finestra.dies=c(-Inf,-1),prefix = "DG.",
                                     cataleg_mana=FALSE)

variable.names(dtagr_diagnostics)


#Agregacio Farmacs Facturats.
dtagr_facturacio<-agregar_facturacio(dt=dt_facturacio,
                                     bd.dindex=dt_index,
                                     finestra.dies=c(-Inf,-1),
                                     dt.agregadors=dt_cataleg,
                                     prefix="FF.",
                                     camp_agregador="agr",
                                     agregar_data=TRUE,
                                     cataleg_mana=FALSE,
                                     acumular=NULL)

variable.names(dtagr_facturacio)


#Agregacio Farmacs Prescripcions.
dtagr_prescripcions<-agregar_prescripcions(dt=dt_prescripcions,
                                           bd.dindex=dt_index,
                                           finestra.dies=c(-Inf,-1),
                                           dt.agregadors=dt_cataleg,
                                           prefix="FP.",
                                           camp_agregador="agr",
                                           agregar_data=TRUE,
                                           cataleg_mana =FALSE,
                                           acumular=NULL)
variable.names(dtagr_prescripcions)
table(dtagr_prescripcions$FP.ANTIDIAB)

#Agregacio Analitiques i Cliniques.
dtagr_variables<-agregar_analitiques(dt=dt_variables,
                                     bd.dindex=dt_index,
                                     finestra.dies = c(-Inf,-1))

#traiem la data Index, per la posterior unificacio.

dtagr_diagnostics<-dtagr_diagnostics%>%select(-dtindex)
dtagr_prescripcions<-dtagr_prescripcions%>%select(-dtindex)
dtagr_facturacio<-dtagr_facturacio%>%select(-dtindex)
dtagr_variables<-dtagr_variables%>%select(-dtindex)

#
#
#
# hem d'estudiar com busquem els DM2!:
#
#
#agregar_problemes(dplyr::select(dt_plana_covid2B,idp,cod,dat),
#                                    bd.dindex = "20000601",
#                                    dt.agregadors=dplyr::select(dt_cataleg2,cod,agr=agr5),
#                                    finestra.dies=c(-Inf,0),prefix = "DM_F.") 
#
#filter(cod=="HBA1C_" & valor >=6.5 )
#
##############################################################################################



```


## 5. Fusio 1

Fusionar part dels arxius agregats 
 
```{r fusio1}


dt_plana1<-dt_index%>%
left_join(dt_poblacio,by="idp")%>%
  left_join(dtagr_diagnostics,by="idp")%>%
    left_join(dtagr_facturacio,by="idp")%>%
     left_join(dtagr_prescripcions,by="idp")%>%
      left_join(dtagr_variables,by="idp")
       
  
#left_join(dt_poblacio_ESP,by="idp")%>%


```
## 6. Generacio GranFuncio: Agregacio+Fusio i convertir a Taula Plana
```{r GranFuncio,include=T}

#Parametres:

#i)
fitxer=c("dt_diagnostics",
         "dt_facturacio",
         "dt_prescripcions",
         "dt_variables")

domini=c("diagnostics",
         "farmacs_facturats",
         "farmacs_prescrits",
         "variables")

Finestra1=c(-Inf,-Inf,-Inf,-Inf)

Finestra2=c(-1,-1,-1,-1)

camp=c("agr","agr","agr","cod")

funcio=c("first","first","first","last")

prefix =c("DG.","FF.","FP.",".valor")

dt_parametres<-data.frame(cbind(fitxer,domini,Finestra1,Finestra2,camp,prefix,funcio))
dt_parametres

#ull es important!!
dt_index$dtindex<-as.character(dt_index$dtindex)


KK<-Generar_taula_plana(
dt=dt_index,
cataleg=dt_cataleg,
parametres=dt_parametres)

dt_plana2<-KK%>%
  left_join(dt_poblacio,by="idp")

#%>%
#left_join(dt_poblacio_ESP,by="idp")



```

## 5. Salvar part1 
```{r SALVAR}
saveRDS(dt_plana2, file=here::here(params$dir_dades_desti,"dt_plana.rds"))

```

```{r Covid_diabetics1,eval=FALSE}
#############################################################################################
#                   B U S C A R     D I A B E T I C S                                              



CATAL<-readxl::read_excel(conductor_codis2,col_types = "text")%>%dplyr::select(cod,agr5,agrE09,agrE10,agrE11)%>%filter(agr5=="DM")
CATAL_INSU<-readxl::read_excel(conductor_codis2,col_types = "text")%>%dplyr::select(cod,agr6)%>%filter(agr6=="INSU")
 
#----------------------------------------------------------------------------#
dt_plana_covid5_gather2<-dt_plana_covid5_gather%>% transmute(idp=PATIENT.ID,cod=CIE10,dat="20200520")
dt_plana_covid6_gather2<-dt_plana_covid6_gather%>% transmute(idp=PATIENT.ID,cod=CIE10,dat="20200520")
# Fusiono dt_PROBLEMES (dt_plana_covid5_gather +dt_plana_covid6_gather )
dt_plana_covid56_gather2<-dt_plana_covid5_gather2%>%bind_rows(dt_plana_covid6_gather2)%>%arrange(idp)
#----------------------------------------------------------------------------#
dt_plana_DM_agr1<-agregar_problemes(dplyr::select(dt_plana_covid56_gather2,idp,cod,dat),
                                    bd.dindex = "20000601",
                                    dt.agregadors=dplyr::select(dt_cataleg2,cod,agr=agr5),
                                    finestra.dies=c(-Inf,Inf),prefix = "DM_P.") 



#----------------------------------------------------------------------------#
#dt_plana_DM_agr1
#----------------------------------------------------------------------------#
GRUP1<-dt_plana_covid56_gather2%>%inner_join(dt_plana_DM_agr1,by="idp")%>%dplyr::select(idp,cod)
GRUP1<-GRUP1%>%inner_join(CATAL,by="cod")
#----------------------------------------------------------------------------#


```


```{r  Covid_diabetics2,eval=FALSE}
##[T2]##.Farmacs.Mètode:Aggregador.
#dt_plana_covid2
dt_plana_covid2B<-dt_plana_covid2%>% transmute(idp=PATIENT.ID,cod=as.character(ID_ATC7),dat="20200520") 
#variable.names(dt_plana_covid2)
#[1] "PATIENT.ID"                                   "FARMACO.DRUG_NOMBRE_COMERCIAL.COMERCIAL_NAME"
#[3] "DOSIS_MEDIA_DIARIA.DAILY_AVRG_DOSE"           "INICIO_TRAT.DRUG_START_DATE"                 
#[5] "FIN_TRAT.DRUG_END_DATE"                       "ATC5_NOMBRE.NAME"                            
#[7] "ID_ATC5"                                      "ATC7_NOMBRE.NAME"                            
#[9] "ID_ATC7"                                     
#----------------------------------------------------------------------------#
dt_plana_DM_agr2<-agregar_problemes(dplyr::select(dt_plana_covid2B,idp,cod,dat),
                                    bd.dindex = "20000601",
                                    dt.agregadors=dplyr::select(dt_cataleg2,cod,agr=agr5),
                                    finestra.dies=c(-Inf,Inf),prefix = "DM_F.") 
#----------------------------------------------------------------------------#
GRUP2<-dt_plana_covid2B%>%inner_join(dt_plana_DM_agr2,by="idp")%>%dplyr::select(idp,cod)
GRUP2<-GRUP2%>%inner_join(CATAL,by="cod")
#----------------------------------------------------------------------------#
```


```{r  Covid_diabetics3,eval=FALSE}

#                          DM--> LABORATORI    [dt_plana_covid4_agr] MAX HbA1c>=6.5%      


#


#dt_plana_DM_agr3                   <-dt_plana_covid4_agr
#dt_plana_DM_agr3$valor             <-as.double(dt_plana_DM_agr3$valor)
#dt_plana_DM_agr3<-dt_plana_DM_agr3%>% filter(cod=="HBA1C_" & valor >=6.5 )


dt_plana_DM_agr3                   <-dt_plana_covid4_agr_B
dt_plana_DM_agr3$valor             <-as.double(dt_plana_DM_agr3$valor)
dt_plana_DM_agr3<-dt_plana_DM_agr3%>% filter(cod=="HBA1C_" & valor >=6.5 )
GRUP3<-dt_plana_DM_agr3%>%dplyr::select(PATIENT.ID,valor, cod)
dt_plana_DM_agr3<-dt_plana_DM_agr3%>% transmute(idp=PATIENT.ID,dtindex="20000601", DM.GLI="20200520")
dt_plana_DM_agr3$idp<-as.numeric(dt_plana_DM_agr3$idp)


DIA_INDEX<-dt_01%>%transmute(idp=PATIENT.ID,DIA.INDEX=F_INGRESO.ADMISSION_D_ING.INPAT)
DIA_INDEX$DIA.INDEX<-as.character(DIA_INDEX$DIA.INDEX)
#DIA_INDEX
#----------------------------------------------------------------------------#
DIA_INDEX$DIA<-substr(DIA_INDEX$DIA.INDEX,1,2)
DIA_INDEX$MES<-substr(DIA_INDEX$DIA.INDEX,4,5)
DIA_INDEX$ANY<-substr(DIA_INDEX$DIA.INDEX,7,10)
#----------------------------------------------------------------------------#
DIA_INDEX$DIA.INDEX2<-paste0(DIA_INDEX$ANY,DIA_INDEX$MES,DIA_INDEX$DIA)
#----------------------------------------------------------------------------#

#----------------------------------------------------------------------------#
DIA_INDEX<-DIA_INDEX%>%dplyr::select(idp,DIA.INDEX2)
#----------------------------------------------------------------------------#


#----------------------------------------------------------------------------#
DIA_INDEX2<-dt_02

DIA_INDEX2$INICIO_TRAT.DRUG_START_DATE<-as.Date(DIA_INDEX2$INICIO_TRAT.DRUG_START_DATE,"%d/%m/%Y")
DIA_INDEX2<-DIA_INDEX2%>% transmute(idp=PATIENT.ID,cod=as.character(ID_ATC7),dat=INICIO_TRAT.DRUG_START_DATE) 
#----------------------------------------------------------------------------#
DIA_INDEX2$ANY<-substr(DIA_INDEX2$dat,1,4)
DIA_INDEX2$MES<-substr(DIA_INDEX2$dat,6,7)
DIA_INDEX2$DIA<-substr(DIA_INDEX2$dat,9,10)
#----------------------------------------------------------------------------#
DIA_INDEX2$dat2<-paste0(DIA_INDEX2$ANY,DIA_INDEX2$MES,DIA_INDEX2$DIA)
DIA_INDEX2<-DIA_INDEX2%>%transmute(idp,cod,dat=dat2)
#----------------------------------------------------------------------------#
dt_plana_DM_agr4<-agregar_problemes(dplyr::select(DIA_INDEX2,idp,cod,dat),
                                    bd.dindex =DIA_INDEX,
                                    dt.agregadors=dplyr::select(dt_cataleg2,cod,agr=agr6),
                                    finestra.dies=c(0,1),prefix = "Far.") 

#AQUI FER-HO!
dt_plana_DM_agr4<-dt_plana_DM_agr4%>%transmute(idp,dtindex,DM.INSU=Far.INSU)


#-------------------------------------------------------#
#dt_plana_DM_agr4
#-------------------------------------------------------#
GRUP4<-DIA_INDEX2%>%inner_join(dt_plana_DM_agr4,by="idp")%>%inner_join(CATAL_INSU,by="cod")
#
#GRUP1
#GRUP2
#GRUP3
#GRUP4
#-----------------------------------------------------------------------------------------------------#
```


```{r  Covid_diabetics4,eval=FALSE}
#-------------------------------------------------------#
dt_plana_DM_agr5<-dt_plana_covid4_agr3%>%dplyr::select(PATIENT.ID,max_pacient_valor_GLU_)
GRUP5<-dt_plana_DM_agr5%>% filter(max_pacient_valor_GLU_>=200 )
dt_plana_DM_agr5<-dt_plana_DM_agr5%>% filter(max_pacient_valor_GLU_>=200 )
dt_plana_DM_agr5<-dt_plana_DM_agr5%>%transmute(idp=PATIENT.ID,DM.GLU_MAX=max_pacient_valor_GLU_)
dt_plana_DM_agr5$idp<-as.numeric(dt_plana_DM_agr5$idp)
#-------------------------------------------------------#






#-----------------------------------------------------------------------------------------------------#
C_DIABETICS<-dt_plana_DM_agr1%>%
  bind_rows(dt_plana_DM_agr2)%>%
  bind_rows(dt_plana_DM_agr3)%>%
  bind_rows(dt_plana_DM_agr4)%>%
  bind_rows(dt_plana_DM_agr5)%>%
  arrange(idp)%>%
  group_by(idp)%>% slice(1) %>% ungroup() %>%dplyr::select(idp)

